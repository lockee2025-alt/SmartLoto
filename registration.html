<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Users</title>
  <script src="https://cdn.tailwindcss.com"></script>

<script type="module">
  import { db } from "./firebase.js";
  import { collection, getDocs, getDoc, addDoc, doc, updateDoc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  document.addEventListener("DOMContentLoaded", async () => {
    const usersTable = document.getElementById("usersTableBody");
    const usersContainer = document.getElementById("usersContainer");
    const loading = document.getElementById("loading");

    const addUserModal = document.getElementById("addUserModal");
    const editUserModal = document.getElementById("editUserModal");

    const showAddModalBtn = document.getElementById("showAddModalBtn");
    const closeAddModalBtn = document.getElementById("closeAddModalBtn");
    const closeEditModalBtn = document.getElementById("closeEditModalBtn");

    const addUserForm = document.getElementById("addUserForm");
    const editUserForm = document.getElementById("editUserForm");

    // ðŸ§‘â€ðŸ’¼ Get logged-in user
    const loggedInUser = JSON.parse(localStorage.getItem("user"));

    if (!loggedInUser) {
      window.location.href = "index.html";
      return;
    }

    // Show/Hide Modals
    closeAddModalBtn.addEventListener("click", () => addUserModal.classList.add("hidden"));
    closeEditModalBtn.addEventListener("click", () => editUserModal.classList.add("hidden"));

    // ðŸ”„ Load users
    async function loadUsers() {
      try {
        loading.classList.remove("hidden");
        usersContainer.classList.add("hidden");
        usersTable.innerHTML = "";

        const usersSnap = await getDocs(collection(db, "users"));
        const companiesSnap = await getDocs(collection(db, "companies"));

        const companyMap = {};
        companiesSnap.forEach((companyDoc) => {
          const data = companyDoc.data();
          companyMap[companyDoc.id] = data.name || companyDoc.id;
        });

        // âœ… Filter users by company if admin
        let filteredUsers = [];
        usersSnap.forEach((docSnap) => {
          const user = docSnap.data();
          if (
            loggedInUser.role === "super_admin" ||
            (loggedInUser.role === "company_admin" && user.companyID === loggedInUser.companyID)
          ) {
            filteredUsers.push({ id: docSnap.id, ...user });
          }
        });

        // ðŸ§¾ Display filtered list
        filteredUsers.forEach((user) => {
          const companyName = companyMap[user.companyID] || user.companyID || "None";

          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
            <td class="px-4 py-2">${user.fullName || ""}</td>
            <td class="px-4 py-2">${user.username || ""}</td>
            <td class="px-4 py-2">${user.role || ""}</td>
            <td class="px-4 py-2">${companyName}</td>
            <td class="px-4 py-2">${user.isActive ? "Yes" : "No"}</td>
            <td class="px-4 py-2 text-center space-x-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded my-4 edit-btn" data-id="${user.id}">Edit</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded delete-btn" data-id="${user.id}">Delete</button>
            </td>
          `;
          usersTable.appendChild(tr);
        });

        // âœï¸ Edit
// âœï¸ Edit button logic
// âœï¸ Edit button
document.querySelectorAll(".edit-btn").forEach((btn) => {
  btn.addEventListener("click", async (e) => {
    const id = e.target.dataset.id;
    const docSnap = usersSnap.docs.find((d) => d.id === id);
    const userData = docSnap.data();

    // Fill basic user info
    editUserForm.userId.value = id;
    editUserForm.fullName.value = userData.fullName || "";
    editUserForm.username.value = userData.username || "";
    editUserForm.password.value = userData.password || "";
    editUserForm.isActive.checked = userData.isActive || false;

    const companySelect = document.getElementById("editCompanyID");
    const companyContainer = document.getElementById("editCompanyContainer");
    const roleSelect = document.getElementById("editRole");

    // Reset role options
    roleSelect.innerHTML = "<option value=''>Select Role</option>";

    if (loggedInUser.role === "super_admin") {
      // SUPER ADMIN: can assign any company
      companyContainer.classList.remove("hidden");
      companySelect.disabled = false;

      // Populate company list
      await loadCompanies(); // make sure loadCompanies fills editCompanySelect
      companySelect.value = userData.companyID || "";

      // Populate roles for selected company (if exists)
      if (userData.companyID) {
        await loadCompanyRoles(userData.companyID, roleSelect);
      }

    // Finally, set selected value
    roleSelect.value = userData.role || "";
    roleSelect.disabled = false;
      // Always allow adding company_admin role
      const option = document.createElement("option");
      option.value = "company_admin";
      option.textContent = "Company Admin";
      roleSelect.appendChild(option);

      roleSelect.value = userData.role || "";
      roleSelect.disabled = false;

    } else if (loggedInUser.role === "company_admin") {
      // COMPANY ADMIN: restricted to own company
      companyContainer.classList.remove("hidden");
      companySelect.value = loggedInUser.companyID;
      companySelect.disabled = true;

      if (loggedInUser.companyID) {
        await loadCompanyRoles(loggedInUser.companyID, roleSelect);
        roleSelect.value = userData.role || "";
        roleSelect.disabled = false;
      } else {
        roleSelect.innerHTML = "<option value=''>No roles available</option>";
        roleSelect.disabled = true;
      }
    }
    editUserModal.classList.remove("hidden");
  });
});




        // ðŸ—‘ï¸ Delete
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            const confirmDelete = confirm("Are you sure you want to delete this user?");
            if (confirmDelete) {
              await deleteDoc(doc(db, "users", id));
              alert("User deleted successfully!");
              await loadUsers();
            }
          });
        });
      } catch (error) {
        console.error("Error loading users:", error);
      } finally {
        loading.classList.add("hidden");
        usersContainer.classList.remove("hidden");
      }
    }

    await loadUsers();

    async function loadCompanyRoles(companyID, roleSelectElement) {
  const companyRef = doc(db, "companies", companyID);
  const companySnap = await getDoc(companyRef);

  roleSelectElement.innerHTML = `<option value="">Select Role</option>`;

  if (!companySnap.exists()) return;

  const data = companySnap.data();
  const roles = data.roles || [];

  roles.forEach(role => {
    roleSelectElement.insertAdjacentHTML(
      "beforeend",
      `<option value="${role}">${role}</option>`
    );
  });
}

    // âž• Add
    addUserForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(addUserForm));

      // ðŸ”’ Auto-assign and hide company for company_admin
      if (loggedInUser.role === "company_admin") {
        formData.companyID = loggedInUser.companyID;
      }

      await addDoc(collection(db, "users"), formData);
      addUserForm.reset();
      addUserModal.classList.add("hidden");
      await loadUsers();
    });

    // âœï¸ Edit
    editUserForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = editUserForm.userId.value;
      const userRef = doc(db, "users", id);
      
      const formData = Object.fromEntries(new FormData(editUserForm));
      
      // Handle checkbox explicitly
      formData.isActive = editUserForm.isActive.checked; // true/false boolean
      
      delete formData.userId;

      await updateDoc(userRef, formData);
      editUserModal.classList.add("hidden");
      await loadUsers();
    });
  });


  async function loadCompanies() {
    const companySnapshot = await getDocs(collection(db, "companies"));
    const addCompanySelect = document.getElementById("addCompanyID");
    const editCompanySelect = document.getElementById("editCompanyID");

    addCompanySelect.innerHTML = `<option value="">Select Company</option>`;
    editCompanySelect.innerHTML = `<option value="">Select Company</option>`;

    companySnapshot.forEach((docSnap) => {
      const company = docSnap.data();
      const optionHTML = `<option value="${docSnap.id}">${company.name || docSnap.id}</option>`;
      addCompanySelect.insertAdjacentHTML("beforeend", optionHTML);
      editCompanySelect.insertAdjacentHTML("beforeend", optionHTML);
      addCompanySelect.addEventListener("change", async () => {
      const companyID = addCompanySelect.value;
      await loadCompanyRoles(companyID, document.getElementById("addRole"));
    });
    });

    // ðŸ”’ Hide dropdown if company_admin
    const loggedInUser = JSON.parse(localStorage.getItem("user"));
    if (loggedInUser && loggedInUser.role === "company_admin") {
      document.getElementById("addCompanyContainer").classList.add("hidden");
      document.getElementById("editCompanyContainer").classList.add("hidden");
    }
  }

  await loadCompanies();
</script>

</head>

<body class="bg-gray-100 font-sans">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-900 text-white flex flex-col justify-between transition-all duration-300">
      <div>
        <div class="flex items-center gap-3 p-2 border-b border-gray-700">
            <button id="toggleSidebar" class="bg-white/20 hover:bg-white/30 p-2 rounded-md focus:outline-none">
                <span class="material-icons [line-height:unset!important]">menu</span>
            </button>
          <div class="sidebar-text">
            <h2 class="font-semibold text-lg" id="name"></h2>
            <p class="text-sm text-gray-400" id="position"></p>
          </div>
        </div>

        <nav class="mt-6 space-y-1">
          <a href="dashboard.html" class="flex items-center gap-3 hover:bg-gray-800 p-3 rounded-r-full">
            <span class="material-icons">dashboard</span> 
            <span class="sidebar-text">Dashboard</span>
          </a>
          <a href="Notification.html" class="flex items-center gap-3 hover:bg-gray-800 p-3 rounded-r-full">
            <span class="material-icons">notifications</span> 
            <span class="sidebar-text">Notification</span>
          </a>
          <a href="Sequence.html" class="flex items-center gap-3 hover:bg-gray-800 p-3 rounded-r-full">
            <span class="material-icons">computer</span> 
            <span class="sidebar-text">Sequence</span>
          </a>
          <a href="registration.html" class="flex items-center gap-3 bg-red-600 p-3 rounded-r-full">
            <span class="material-icons">group</span>
            <span class="sidebar-text">Accounts</span>
          </a>
          <a href="companies.html" class="flex items-center gap-3 hover:bg-gray-800 p-3 rounded-r-full">
            <span class="material-icons">apartment</span>
            <span class="sidebar-text">Companies</span>
          </a>
          <a href="locks.html" class="flex items-center gap-3 hover:bg-gray-800 p-3 rounded-r-full">
            <span class="material-icons">lock</span>
            <span class="sidebar-text">Locks</span>
          </a>
        </nav>
      </div>

      <div class="border-t border-gray-700">
        <a id="logoutBtn" class="flex items-center gap-3 hover:bg-gray-800 p-3 cursor-pointer">
          <span class="material-icons">logout</span> 
          <span class="sidebar-text">Logout</span>
        </a>
        <a href="account.html" class="flex items-center gap-3 hover:bg-gray-800 p-3">
          <span class="material-icons">account_circle</span> 
          <span class="sidebar-text">Account</span>
        </a>
        <a href="about.html" class="flex items-center gap-3 hover:bg-gray-800 p-3">
          <span class="material-icons">info</span> 
          <span class="sidebar-text">About</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-[300px] md:min-w-0" id="dashboard">
      <header class="bg-red-600 text-white flex justify-between items-center px-6 py-4">
        <h1 class="text-2xl font-bold">All Users</h1>
        <div>
        </div>
      </header>

      <!-- ðŸ”¹ Loading Spinner -->
      <div id="loading" class="flex flex-col justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-red-500 border-t-transparent mb-4"></div>
        <p class="text-gray-600">Loading users...</p>
      </div>

      <!-- ðŸ”¹ Users Table -->
<div id="usersContainer" class="p-4 md:p-6 hidden h-[400px] md:h-[800px] overflow-y-auto pr-2 scrollbar-thin scroll-smooth">
  <!-- âœ… Dedicated scroll container -->
  <div class="w-full overflow-x-auto">
    <div class="inline-block min-w-full align-middle">
      <div class="overflow-hidden border border-gray-200 rounded-lg shadow">
        <table class="min-w-[800px] w-full divide-y divide-gray-200 bg-white">
          <thead class="bg-gray-200 text-gray-600 uppercase text-sm">
            <tr>
              <th class="px-4 py-2 text-left whitespace-nowrap">Full Name</th>
              <th class="px-4 py-2 text-left whitespace-nowrap">Username</th>
              <th class="px-4 py-2 text-left whitespace-nowrap">Role</th>
              <th class="px-4 py-2 text-left whitespace-nowrap">Company Name</th>
              <th class="px-4 py-2 text-left whitespace-nowrap">Active</th>
              <th class="px-4 py-2 text-center whitespace-nowrap">Action</th>
            </tr>
          </thead>
          <tbody id="usersTableBody" class="text-gray-700 divide-y"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>




  <!-- Add User Modal -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Add New User</h2>

    <form id="addUserForm" class="space-y-4">

      <!-- Full Name -->
      <div>
        <label for="addFullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
        <input id="addFullName" name="fullName" type="text" class="w-full border px-3 py-2 rounded" required>
      </div>

      <!-- Username -->
      <div>
        <label for="addUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input id="addUsername" name="username" type="text" class="w-full border px-3 py-2 rounded" required>
      </div>

      <!-- Password -->
      <div>
        <label for="addPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input id="addPassword" name="password" type="text" class="w-full border px-3 py-2 rounded" required>
      </div>

      <!-- Role -->
      <div>
        <label for="addRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
        <select name="role" id="addRole" class="w-full border px-3 py-2 rounded" required>
          <option value="">Select Role</option>
        </select>
      </div>

      <!-- Company -->
      <div id="addCompanyContainer">
        <label for="addCompanyID" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
        <select name="companyID" id="addCompanyID" class="w-full border px-3 py-2 rounded">
          <option value="">Select Company</option>
        </select>
      </div>


      <!-- Active -->
      <div class="flex items-center gap-2">
        <input type="checkbox" name="isActive" id="isActive" class="w-4 h-4" checked>
        <label for="isActive" class="text-sm text-gray-700">Active</label>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" id="closeAddModalBtn" class="px-4 py-2 bg-gray-400 rounded text-white">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded">Create</button>
      </div>

    </form>
  </div>
</div>


  <!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Edit User</h2>

    <form id="editUserForm" class="space-y-4">
      <input type="hidden" name="userId" />

      <!-- Full Name -->
      <div>
        <label for="editFullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
        <input id="editFullName" name="fullName" type="text" class="w-full border px-3 py-2 rounded" required>
      </div>

      <!-- Username -->
      <div>
        <label for="editUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input id="editUsername" name="username" type="text" class="w-full border px-3 py-2 rounded" required>
      </div>

      <!-- Password -->
      <div>
        <label for="editPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input id="editPassword" name="password" type="text" class="w-full border px-3 py-2 rounded" required>
      </div>

      <!-- Role -->
      <div>
        <label for="editRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
        <select name="role" id="editRole" class="w-full border px-3 py-2 rounded" required>
          <option value="">Select Role</option>
        </select>
      </div>

      <!-- Company -->
      <div id="editCompanyContainer">
        <label for="editCompanyID" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
        <select name="companyID" id="editCompanyID" class="w-full border px-3 py-2 rounded">
          <option value="">Select Company</option>
        </select>
      </div>

      <!-- Active -->
      <div class="flex items-center gap-2">
        <input type="checkbox" name="isActive" id="editIsActive" class="w-4 h-4">
        <label for="editIsActive" class="text-sm text-gray-700">Active</label>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="closeEditModalBtn" class="px-4 py-2 bg-gray-400 rounded text-white">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save Changes</button>
      </div>
    </form>
  </div>
</div>
  </div>
  <script>
    const toggleButton = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    const textElements = document.querySelectorAll(".sidebar-text");
    const dashboard = document.getElementById("dashboard");
  
    // Collapse sidebar by default on mobile
    if (window.innerWidth < 1024) {
      sidebar.classList.remove("w-64");
      sidebar.classList.add("w-14");
      textElements.forEach(el => el.classList.add("hidden"));
    }
  
    toggleButton.addEventListener("click", () => {
      if (window.innerWidth < 1024) {
        // MOBILE: toggle full-screen sidebar
        sidebar.classList.toggle("fixed");
        sidebar.classList.toggle("inset-0");
        sidebar.classList.toggle("!w-full");
        sidebar.classList.toggle("z-50");
        dashboard.classList.toggle("hidden");
  
        // toggle text visibility
        textElements.forEach(el => {
          el.classList.toggle("hidden");
        });
      } else {
        // DESKTOP: toggle between wide and collapsed
        sidebar.classList.toggle("w-64");
        sidebar.classList.toggle("w-14");
        textElements.forEach(el => {
          el.classList.toggle("hidden");
        });
      }
    });
  </script>

  <script type="module">
    import { db } from "./firebase.js";
    const loggedInUser = JSON.parse(localStorage.getItem("user"));
    const name = document.getElementById("name");
    const position = document.getElementById("position");

    if (!loggedInUser) {
      window.location.href = "index.html";
    } else {
      name.innerHTML = loggedInUser.fullName || "N/A";
      position.innerHTML = loggedInUser.role || "N/A";
    }

      const logoutBtn = document.getElementById("logoutBtn");
      logoutBtn.onclick = () => {
        localStorage.removeItem("user");
        window.location.href = "index.html";
      };
  </script>
    

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
</body>
</html>
